<?php
/**
 * @file
 * Drupal functions for sbkopi
 */

/** load field hooks * */
include_once 'includes/bibdk_reservation_sb_kopi.inc';
include_once 'bibdk_sbkopi.ajax.inc';

/**
 * Implements hook_ting_client_webservice().
 *
 * @see ting_client.module
 */
function bibdk_sbkopi_ting_client_webservice() {
  $ret = array();
  $ret['statsbib']['class'] = 'bibdk_statsbib';
  $ret['statsbib']['url'] = 'bibdk_statsbib_url';
  return $ret;
}

/**
 * Implements hook_form_FORM_ID_alter (ting_client_admin_webservices_settings)
 * add 2 fields to webservice client settings
 *
 * @url to borchk
 * @servicerequester
 * */
function bibdk_sbkopi_form_ting_client_admin_webservices_settings_alter(&$form, &$form_state) {
  $form['sbkopi'] = array(
    '#type' => 'fieldset',
    '#title' => t('SB Copy Settings'),
    '#descriptions' => t('Settings for SB copy service'),
  );
  $form['sbkopi']['bibdk_statsbib_url'] = array(
    '#type' => 'textfield',
    '#title' => t('URL to create user service @ statsbiblioteket'),
    '#description' => t('URL to statsbibliotekets user api e.g., https://webservice.statsbiblioteket.dk/ws-create-user1/CreateUser'),
    '#required' => TRUE,
    '#default_value' => variable_get('bibdk_statsbib_url', FALSE),
  );
  $form['sbkopi']['bibdk_sbkopi_place_copy_request_url'] = array(
    '#type' => 'textfield',
    '#title' => t('URL to create user service @ statsbiblioteket'),
    '#description' => t('URL to statsbibliotekets place copy service e.g., https://webservice.statsbiblioteket.dk/placeCopyRequest'),
    '#required' => TRUE,
    '#default_value' => variable_get('bibdk_sbkopi_place_copy_request_url', FALSE),
  );
  $form['sbkopi']['bibdk_sbkopi_request_user'] = array(
    '#type' => 'textfield',
    '#title' => t('Service username'),
    '#description' => t('User for authentication on service'),
    '#required' => TRUE,
    '#default_value' => variable_get('bibdk_sbkopi_request_user', FALSE),
  );
  $form['sbkopi']['bibdk_sbkopi_request_pass'] = array(
    '#type' => 'textfield',
    '#title' => t('Service password'),
    '#description' => t('Password for authentication on service'),
    '#required' => TRUE,
    '#default_value' => variable_get('bibdk_sbkopi_request_pass', FALSE),
  );
}

/**
 * Implements hook_menu().
 *
 * @return mixed
 */
function bibdk_sbkopi_menu() {
  $items['sbkopi/ajax'] = array(
    'page callback' => 'bibdk_sbkopi_ajax_get_options',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'bibdk_sbkopi.ajax.inc',
  );

  $items['reservation/sbkopi/%'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_sbkopi_reservation_form', 2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'inc/bibdk_sbkopi.reservation.inc',
  );
  $items['reservation/sbkopi/receipt/%'] = array(
    'page callback' => 'bibdk_sbkopi_reservation_receipt',
    'page arguments' => array(3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'inc/bibdk_sbkopi.reservation.inc',
  );

  return $items;
}

/**
 * Implements hook_ting_openformat_actions().
 */
function bibdk_sbkopi_ting_openformat_actions($type, $entity, $view_mode, $langcode) {
  if ($type == 'bibdkManifestation') {
    // only for type 'Tidsskriftsartikel
    if ($entity->getSubType() == 'Tidsskriftsartikel') {
      $actions['sbkpopi'] = array(
        '#theme' => 'html_tag',
        '#tag' => 'span',
        '#attributes' => array(
          'class' => 'bibdk-sb_kopi-replaceme',
          'pid' => $entity->id
        ),
        '#weight' => 0.1,
        '#attached' => array('js' => array(drupal_get_path('module', 'bibdk_sbkopi') . '/js/ajaxGetCopyOptions.js')),
      );

      return $actions;
    }
  }
}

/**
 * Implements hook_bibdk_usersettings_user_tabs().
 *
 * @return array
 */
function bibdk_sbkopi_bibdk_usersettings_user_tabs() {
  $tab['sb_kopi'] = array(
    'title' => t('sb_selvhenter', array(), array('context' => 'bibdk_reservation')),
    'description' => t('sb_selvhenter_description', array(), array('context' => 'bibdk_reservation')),
    'weight' => 2,
  );

  return $tab;
}

/**
 * Implements hook_bibdk_usersettings_user_settings().
 *
 * @return array
 */
function bibdk_sbkopi_bibdk_usersettings_user_settings() {
  $form['sb_kopi'] = array(
    '#type' => 'container',
    '#weight' => 0,
    '#tab' => 'sb_kopi',
  );

  $form['sb_kopi']['bibdk_actions_sb_selfpickup'] = array(
    '#type' => 'checkbox',
    '#title' => t('sb_selvhenter_description', array(), array('context' => 'bibdk_usersettings')),
    '#default_value' => bibdk_usersettings_user_settings_get('bibdk_actions_sb_selfpickup', TRUE),
  );
  return $form;
}

